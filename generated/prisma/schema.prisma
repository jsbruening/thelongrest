// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
  url      = env("DATABASE_URL")
}

// Necessary for Next auth
model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? // @db.Text
  access_token             String? // @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? // @db.Text
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                  String               @id @default(cuid())
  name                String?
  displayName         String? // User's display name (preferred over name)
  email               String?              @unique
  emailVerified       DateTime?
  image               String? // User avatar URL
  passwordHash        String? // For credentials auth
  accounts            Account[]
  sessions            Session[]
  campaigns           Campaign[]
  characters          Character[]
  campaignCharacters  CampaignCharacter[]
  sessionParticipants SessionParticipant[]
  drawings            Drawing[]
  spellEffects        SpellEffect[]
  chatMessages        ChatMessage[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// VTT Models

enum SessionStatus {
  PLANNED
  ACTIVE
  COMPLETED
}

enum EffectType {
  CIRCLE
  SPHERE
  CONE
  RECTANGLE
  LINE
}

enum MessageType {
  TEXT
  SYSTEM
  DICE_ROLL
}

model Campaign {
  id          String   @id @default(cuid())
  name        String
  description String?
  dmId        String
  dm          User     @relation(fields: [dmId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sessions           GameSession[]
  campaignCharacters CampaignCharacter[]

  @@index([dmId])
}

model GameSession {
  id          String        @id @default(cuid())
  campaignId  String
  campaign    Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name        String
  scheduledAt DateTime?
  status      SessionStatus @default(PLANNED)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  map          Map?
  tokens       Token[]
  fogOfWar     FogOfWarState?
  drawings     Drawing[]
  effects      SpellEffect[]
  participants SessionParticipant[]
  chatMessages ChatMessage[]

  @@index([campaignId])
}

model Character {
  id        String   @id @default(cuid())
  userId    String // Required - characters belong to users
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  race      String
  class     String
  avatarUrl String? // Character avatar image URL
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaignCharacters CampaignCharacter[]

  @@index([userId])
}

model CampaignCharacter {
  id          String    @id @default(cuid())
  campaignId  String
  campaign    Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  level       Int       @default(1) // Campaign-specific level
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  token  Token?
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@unique([campaignId, characterId])
  @@index([campaignId])
  @@index([characterId])
}

model Map {
  id        String      @id @default(cuid())
  sessionId String      @unique
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  name      String
  filePath  String // Path to .vtt file
  imagePath String // Path to map image
  width     Int // Map width in pixels
  height    Int // Map height in pixels
  gridSize  Int         @default(70) // Grid size in pixels
  walls     Json? // Parsed wall data from .vtt
  doors     Json? // Parsed door data
  lighting  Json? // Lighting data
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model Token {
  id                  String             @id @default(cuid())
  sessionId           String
  session             GameSession        @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  campaignCharacterId String?            @unique
  campaignCharacter   CampaignCharacter? @relation(fields: [campaignCharacterId], references: [id], onDelete: SetNull)
  name                String
  x                   Float // Position X
  y                   Float // Position Y
  size                Int                @default(1) // Grid squares
  visionRadius        Float? // Vision radius in feet
  hasDarkvision       Boolean            @default(false)
  imageUrl            String? // Token image (overrides character avatar)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  @@index([sessionId])
}

model FogOfWarState {
  id            String      @id @default(cuid())
  sessionId     String      @unique
  session       GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  revealedAreas Json // Array of polygon coordinates
  updatedAt     DateTime    @updatedAt
}

model Drawing {
  id          String      @id @default(cuid())
  sessionId   String
  session     GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  path        Json // Array of points [{x, y}, ...]
  color       String      @default("#000000")
  strokeWidth Int         @default(2)
  createdAt   DateTime    @default(now())

  @@index([sessionId])
}

model SpellEffect {
  id        String      @id @default(cuid())
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      EffectType
  x         Float
  y         Float
  radius    Float? // For circles/spheres
  width     Float? // For rectangles/cones
  height    Float? // For rectangles/cones
  angle     Float? // For cones
  color     String
  opacity   Float       @default(0.3)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([sessionId])
}

model ChatMessage {
  id        String      @id @default(cuid())
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  type      MessageType @default(TEXT)
  createdAt DateTime    @default(now())

  @@index([sessionId])
  @@index([createdAt])
}

model SessionParticipant {
  id        String      @id @default(cuid())
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt  DateTime    @default(now())

  @@unique([sessionId, userId])
  @@index([sessionId])
}
